<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PAC-MAN</title>
    <script src="coin-system.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        #game {
            background: #000;
            border: 3px solid #00f;
        }
        #ui {
            color: #fff;
            font-size: 24px;
            text-align: center;
            margin-bottom: 10px;
        }
        .container {
            text-align: center;
        }
        #back {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #00f;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #back:hover {
            background: #00a;
        }
    </style>
</head>
<body>
    <button id="back" onclick="window.location.href='og_gamezz_portal.html'">← Back</button>
    <div class="container">
        <div id="ui">Score: 0 | Lives: 3 | Level: 1</div>
        <canvas id="game" width="560" height="620"></canvas>
    </div>
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const TILE = 20;
        const COLS = 28;
        const ROWS = 31;
        
        // Jednoduchý maze (# = zeď, . = tečka, o = power pellet, - = ghost house)
        const maze = [
            "############################",
            "#............##............#",
            "#.####.#####.##.#####.####.#",
            "#o####.#####.##.#####.####o#",
            "#.####.#####.##.#####.####.#",
            "#..........................#",
            "#.####.##.########.##.####.#",
            "#.####.##.########.##.####.#",
            "#......##....##....##......#",
            "######.##### ## #####.######",
            "######.##### ## #####.######",
            "######.##          ##.######",
            "######.## ###--### ##.######",
            "######.## #      # ##.######",
            "      .   #      #   .      ",
            "######.## #      # ##.######",
            "######.## ######## ##.######",
            "######.##          ##.######",
            "######.## ######## ##.######",
            "######.## ######## ##.######",
            "#............##............#",
            "#.####.#####.##.#####.####.#",
            "#.####.#####.##.#####.####.#",
            "#o..##.......  .......##..o#",
            "###.##.##.########.##.##.###",
            "###.##.##.########.##.##.###",
            "#......##....##....##......#",
            "#.##########.##.##########.#",
            "#.##########.##.##########.#",
            "#..........................#",
            "############################"
        ];

        // Herní stav
        let score = 0;
        let lives = 3;
        let level = 1;
        let gameOver = false;
        let won = false;
        let dots = 0;
        let totalDots = 0;
        let powerMode = 0;

        // PAC-MAN (grid pozice)
        let pacman = {
            x: 14,
            y: 23,
            dir: 0, // 0=none, 1=right, 2=down, 3=left, 4=up
            nextDir: 0,
            speed: 5, // frames per move
            frame: 0,
            mouthOpen: true
        };

        // DUCHOVÉ
        let ghosts = [
            {x: 14, y: 11, dir: 1, color: '#ff0000', speed: 6, scared: false},
            {x: 12, y: 13, dir: 3, color: '#ffb8ff', speed: 6, scared: false},
            {x: 15, y: 13, dir: 1, color: '#00ffff', speed: 6, scared: false},
            {x: 13, y: 15, dir: 4, color: '#ffb852', speed: 6, scared: false}
        ];

        // Počítej tečky
        function countDots() {
            totalDots = 0;
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (maze[r][c] === '.' || maze[r][c] === 'o') totalDots++;
                }
            }
            dots = totalDots;
        }

        // Kontrola zdi
        function isWall(x, y) {
            if (y < 0 || y >= ROWS || x < 0 || x >= COLS) return true;
            const tile = maze[y][x];
            return tile === '#' || tile === '-';
        }

        // Pohyb Pac-Mana
        function movePacman() {
            pacman.frame++;
            if (pacman.frame < pacman.speed) return;
            pacman.frame = 0;
            pacman.mouthOpen = !pacman.mouthOpen;

            // Zkus nový směr
            if (pacman.nextDir) {
                let nx = pacman.x, ny = pacman.y;
                if (pacman.nextDir === 1) nx++;
                else if (pacman.nextDir === 2) ny++;
                else if (pacman.nextDir === 3) nx--;
                else if (pacman.nextDir === 4) ny--;

                // Tunnel
                if (nx < 0) nx = COLS - 1;
                if (nx >= COLS) nx = 0;

                if (!isWall(nx, ny)) {
                    pacman.dir = pacman.nextDir;
                }
            }

            // Pohyb
            if (pacman.dir) {
                let nx = pacman.x, ny = pacman.y;
                if (pacman.dir === 1) nx++;
                else if (pacman.dir === 2) ny++;
                else if (pacman.dir === 3) nx--;
                else if (pacman.dir === 4) ny--;

                // Tunnel
                if (nx < 0) nx = COLS - 1;
                if (nx >= COLS) nx = 0;

                if (!isWall(nx, ny)) {
                    pacman.x = nx;
                    pacman.y = ny;

                    // Seber tečku
                    if (maze[ny][nx] === '.') {
                        maze[ny] = maze[ny].substring(0, nx) + ' ' + maze[ny].substring(nx + 1);
                        score += 10;
                        dots--;
                        coinSystem.addCoins(1);
                        if (dots === 0) {
                            won = true;
                            setTimeout(nextLevel, 2000);
                        }
                    }
                    // Power pellet
                    else if (maze[ny][nx] === 'o') {
                        maze[ny] = maze[ny].substring(0, nx) + ' ' + maze[ny].substring(nx + 1);
                        score += 50;
                        dots--;
                        powerMode = 200; // 200 frames
                        ghosts.forEach(g => g.scared = true);
                        coinSystem.addCoins(5);
                    }
                }
            }
        }

        // Pohyb duchů
        function moveGhost(ghost) {
            ghost.frame = (ghost.frame || 0) + 1;
            if (ghost.frame < ghost.speed) return;
            ghost.frame = 0;

            // Možné směry
            let dirs = [];
            if (!isWall(ghost.x + 1, ghost.y)) dirs.push(1);
            if (!isWall(ghost.x, ghost.y + 1)) dirs.push(2);
            if (!isWall(ghost.x - 1, ghost.y)) dirs.push(3);
            if (!isWall(ghost.x, ghost.y - 1)) dirs.push(4);

            // Necouvej
            let opposite = {1: 3, 2: 4, 3: 1, 4: 2};
            dirs = dirs.filter(d => d !== opposite[ghost.dir]);

            if (dirs.length > 0) {
                // Scared = náhodně
                if (ghost.scared) {
                    ghost.dir = dirs[Math.floor(Math.random() * dirs.length)];
                }
                // Chase Pac-Man
                else {
                    let best = ghost.dir;
                    let minDist = 999;
                    dirs.forEach(d => {
                        let nx = ghost.x, ny = ghost.y;
                        if (d === 1) nx++;
                        else if (d === 2) ny++;
                        else if (d === 3) nx--;
                        else if (d === 4) ny--;
                        let dist = Math.abs(nx - pacman.x) + Math.abs(ny - pacman.y);
                        if (dist < minDist) {
                            minDist = dist;
                            best = d;
                        }
                    });
                    ghost.dir = best;
                }
            }

            // Pohni se
            if (ghost.dir === 1) ghost.x++;
            else if (ghost.dir === 2) ghost.y++;
            else if (ghost.dir === 3) ghost.x--;
            else if (ghost.dir === 4) ghost.y--;

            // Tunnel
            if (ghost.x < 0) ghost.x = COLS - 1;
            if (ghost.x >= COLS) ghost.x = 0;
        }

        // Kolize
        function checkCollisions() {
            ghosts.forEach(ghost => {
                if (ghost.x === pacman.x && ghost.y === pacman.y) {
                    if (ghost.scared) {
                        score += 200;
                        coinSystem.addCoins(10);
                        ghost.x = 14;
                        ghost.y = 11;
                        ghost.scared = false;
                    } else {
                        lives--;
                        if (lives <= 0) {
                            gameOver = true;
                        } else {
                            pacman.x = 14;
                            pacman.y = 23;
                            pacman.dir = 0;
                            ghosts[0].x = 14; ghosts[0].y = 11;
                            ghosts[1].x = 12; ghosts[1].y = 13;
                            ghosts[2].x = 15; ghosts[2].y = 13;
                            ghosts[3].x = 13; ghosts[3].y = 15;
                        }
                    }
                }
            });
        }

        // Vykreslení
        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Maze
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const tile = maze[r][c];
                    if (tile === '#' || tile === '-') {
                        ctx.fillStyle = '#0000ff';
                        ctx.fillRect(c * TILE, r * TILE, TILE, TILE);
                    } else if (tile === '.') {
                        ctx.fillStyle = '#ffb8ff';
                        ctx.beginPath();
                        ctx.arc(c * TILE + TILE / 2, r * TILE + TILE / 2, 2, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (tile === 'o') {
                        ctx.fillStyle = '#fff';
                        ctx.beginPath();
                        ctx.arc(c * TILE + TILE / 2, r * TILE + TILE / 2, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }

            // Pac-Man
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            let angle = pacman.mouthOpen ? 0.25 : 0.1;
            let rotation = (pacman.dir - 1) * Math.PI / 2;
            ctx.arc(pacman.x * TILE + TILE / 2, pacman.y * TILE + TILE / 2, TILE / 2 - 2, 
                    rotation + angle * Math.PI, rotation + (2 - angle) * Math.PI);
            ctx.lineTo(pacman.x * TILE + TILE / 2, pacman.y * TILE + TILE / 2);
            ctx.fill();

            // Duchové
            ghosts.forEach(ghost => {
                ctx.fillStyle = ghost.scared ? '#0000ff' : ghost.color;
                // Tělo
                ctx.beginPath();
                ctx.arc(ghost.x * TILE + TILE / 2, ghost.y * TILE + TILE / 2, TILE / 2 - 2, Math.PI, 0);
                ctx.lineTo(ghost.x * TILE + TILE - 2, ghost.y * TILE + TILE - 2);
                ctx.lineTo(ghost.x * TILE + TILE - 6, ghost.y * TILE + TILE / 2 + 3);
                ctx.lineTo(ghost.x * TILE + TILE / 2, ghost.y * TILE + TILE - 2);
                ctx.lineTo(ghost.x * TILE + 6, ghost.y * TILE + TILE / 2 + 3);
                ctx.lineTo(ghost.x * TILE + 2, ghost.y * TILE + TILE - 2);
                ctx.closePath();
                ctx.fill();

                // Oči
                ctx.fillStyle = '#fff';
                ctx.fillRect(ghost.x * TILE + 5, ghost.y * TILE + 6, 5, 6);
                ctx.fillRect(ghost.x * TILE + TILE - 10, ghost.y * TILE + 6, 5, 6);
                ctx.fillStyle = '#000';
                ctx.fillRect(ghost.x * TILE + 7, ghost.y * TILE + 8, 3, 3);
                ctx.fillRect(ghost.x * TILE + TILE - 8, ghost.y * TILE + 8, 3, 3);
            });

            // UI
            document.getElementById('ui').textContent = 
                `Score: ${score} | Lives: ${lives} | Level: ${level}`;

            // Game Over
            if (gameOver) {
                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ff0000';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2);
                ctx.font = '24px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText('Press R to restart', canvas.width / 2, canvas.height / 2 + 50);
            }

            // Won
            if (won && !gameOver) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#00ff00';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('LEVEL COMPLETE!', canvas.width / 2, canvas.height / 2);
            }
        }

        // Update
        function update() {
            if (!gameOver && !won) {
                movePacman();
                ghosts.forEach(moveGhost);
                checkCollisions();
                
                if (powerMode > 0) {
                    powerMode--;
                    if (powerMode === 0) {
                        ghosts.forEach(g => g.scared = false);
                    }
                }
            }
            draw();
            requestAnimationFrame(update);
        }

        // Next Level
        function nextLevel() {
            level++;
            won = false;
            pacman.x = 14;
            pacman.y = 23;
            pacman.dir = 0;
            pacman.speed = Math.max(3, pacman.speed - 1);
            ghosts.forEach((g, i) => {
                g.x = [14, 12, 15, 13][i];
                g.y = [11, 13, 13, 15][i];
                g.speed = Math.max(4, g.speed - 1);
                g.scared = false;
            });
            
            // Reset maze
            maze[1] = "#............##............#";
            maze[2] = "#.####.#####.##.#####.####.#";
            maze[3] = "#o####.#####.##.#####.####o#";
            maze[4] = "#.####.#####.##.#####.####.#";
            maze[5] = "#..........................#";
            maze[6] = "#.####.##.########.##.####.#";
            maze[7] = "#.####.##.########.##.####.#";
            maze[8] = "#......##....##....##......#";
            maze[20] = "#............##............#";
            maze[21] = "#.####.#####.##.#####.####.#";
            maze[22] = "#.####.#####.##.#####.####.#";
            maze[23] = "#o..##.......  .......##..o#";
            maze[26] = "#......##....##....##......#";
            maze[27] = "#.##########.##.##########.#";
            maze[28] = "#.##########.##.##########.#";
            maze[29] = "#..........................#";
            
            countDots();
        }

        // Restart
        function restart() {
            score = 0;
            lives = 3;
            level = 1;
            gameOver = false;
            won = false;
            pacman.x = 14;
            pacman.y = 23;
            pacman.dir = 0;
            pacman.speed = 5;
            ghosts[0] = {x: 14, y: 11, dir: 1, color: '#ff0000', speed: 6, scared: false};
            ghosts[1] = {x: 12, y: 13, dir: 3, color: '#ffb8ff', speed: 6, scared: false};
            ghosts[2] = {x: 15, y: 13, dir: 1, color: '#00ffff', speed: 6, scared: false};
            ghosts[3] = {x: 13, y: 15, dir: 4, color: '#ffb852', speed: 6, scared: false};
            nextLevel();
        }

        // Klávesy
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowRight') pacman.nextDir = 1;
            else if (e.key === 'ArrowDown') pacman.nextDir = 2;
            else if (e.key === 'ArrowLeft') pacman.nextDir = 3;
            else if (e.key === 'ArrowUp') pacman.nextDir = 4;
            else if (e.key === 'r' || e.key === 'R') {
                if (gameOver) restart();
            }
        });

        // Start
        countDots();
        update();
    </script>
</body>
</html>